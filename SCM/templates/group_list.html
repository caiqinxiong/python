{% extends 'layout.html' %}

{% block css %}
    <style>
        .hide {
            display: none;
        }

        .shadow {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background-color: black;
            opacity: 0.4;
            z-index: 999;
        }

        .modal-pr {
            z-index: 1000;
            position: fixed;
            left: 50%;
            top: 50%;
            height: 300px;
            width: 400px;
            background-color: white;
            margin-left: -200px;
            margin-top: -150px;
        }
    </style>

{% endblock %}

{% block content %}

    <div style="width: 90%;margin: 0 auto;">
        <h1>用户组列表</h1>
        <div style="margin: 10px 0;">
{#            <a class="btn btn-info" onclick="showModal();">添加</a>#}
            <a class="btn btn-info" href="{% url 'add_group' %}">添加</a>
        </div>
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                {#            <th>序号</th>#}
                <th>ID</th>
                <th>组名</th>
                <th>用户</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for row in group_info %}
                <tr>
                    {#                <td>{{ forloop.counter }}</td>#}
                    <td>{{ row.id }}</td>
                    <td>{{ row.gname }}</td>
                    <td>
                        {% for item in  row.u2g.all %}
                            <span style="border: 1px solid #ccc;padding: 5px;">{{ item }}</span>
                        {% endfor %}
                    </td>
                    <td>{{row.createtime}}</td>
                    <td>
{#                        <a class="btn-sm btn-primary" onclick="modelEdit(this);"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编辑</a>#}
                        <a class="btn-sm btn-primary" href="{% url 'edit_group' row.id %}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i>编辑</a>
                        <a class="btn-sm btn-danger" onclick="removeRow(this,{{ row.id }})"><i class="fa fa-trash" aria-hidden="true"></i>删除</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="shadow" class="shadow hide"></div>
    <div id="modal" class="panel panel-primary modal-pr hide">
        <div class="panel-heading">添加组</div>
        <br>
        <br>
        <form class="form-horizontal">
            <div class="form-group">
                <label for="gname" class="col-sm-2 control-label">组名</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="gname" name="gname" placeholder="组名">
                </div>
            </div>
            <p id="errormsg" style="color: red"></p>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-8">
                    <button type="submit" class="btn btn-success" value="提交" onclick="AjaxSend();">提交</button>
                    <button type="submit" class="btn btn-primary" value="取消" onclick="cancleModal();">取消</button>
                </div>
            </div>
        </form>

    </div>
    <div id="editModal" class="modal-pr hide panel panel-success">
        <div class="panel-heading">编辑组</div>
        <br>
        <br>
        <form class="form-horizontal">
            <div class="form-group">
                <label for="editGname" class="col-sm-2 control-label">组名</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="editGname" name="gname" placeholder="组名">
                </div>
            </div>
            <input id="editId" type="text" name="id" style="display: none"/>
            <p id="errormsg" style="color: red"></p>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-8">
                    <button type="submit" class="btn btn-success" value="提交" onclick="editAjaxSend();">提交</button>
                    <button type="submit" class="btn btn-primary" value="取消" onclick="cancleModal();">取消</button>
                </div>
            </div>
        </form>

    </div>
{% endblock %}
{% block js %}
    <script src="/static/js/jquery-1.12.4.js"></script>
    <script>
        function showModal() {
            document.getElementById('shadow').classList.remove('hide');
            document.getElementById('modal').classList.remove('hide');
        }

        function cancleModal() {
            document.getElementById('shadow').classList.add('hide');
            document.getElementById('modal').classList.add('hide');
            document.getElementById('editModal').classList.add('hide');
        }

        function AjaxSend() {
            $.ajax({
                url: '/rim/add_group/',
                type: 'POST',
                data: {'gname': $('#gname').val()},
                async: false,
                success: function (arg) {
                    console.log(arg);
                    arg = JSON.parse(arg);
                    console.log(arg);
                    if (arg.status) {
                        location.reload();
                    } else {
                        alert(arg.message);
                    }
                }
            })
        }

        function modelEdit(ths) {
            document.getElementById('shadow').classList.remove('hide');
            document.getElementById('editModal').classList.remove('hide');
            /*
            1. 获取当前点击标签
            2. 当前标签父标签，再找其上方标签
            3. 获取当前行班级名称，赋值到编辑对话框中
             */
            var row = $(ths).parent().prevAll();
            var gname = $(row[2]).text();
            $('#editGname').val(gname);
            var contentId = $(row[3]).text();
            $('#editId').val(contentId);
        }


        function editAjaxSend() {
            //编辑信息
            var id = $('#editId').val();
            var gname = $('#editGname').val();
            $.ajax({
                url: '/rim/edit_group/',
                type: 'POST',
                data: {'id': id, 'gname': gname},
                async: false,//解决刷新失败
                success: function (arg) {
                    // arg字符串类型
                    // JSON.parse(字符串) => 对象
                    // JSON.stringify(对象) => 字符串
                    arg = JSON.parse(arg);
                    if (arg.status) {
                        location.reload();
                    } else {
                        alert(arg.message);
                    }
                }
            })
        }

        function removeRow(ths, rid) {
            swal({
                title: "确定删除选中的记录?",
                text: "删除之后无法恢复该数据!",
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                cancelButtonText: "取消",
                confirmButtonText: "确定",
                closeOnConfirm: true
            }, function (isConfirm) {
                if (isConfirm) {
                    $.ajax({
                        url: '/rim/group/del/' + rid + '/',
                        type: 'get',
                        dataType: "JSON",
                        success: function (res) {
                            if (res.status) {
                                $(ths).parent().parent().remove();
                            }
                        }
                    });
                }
            })
        }
    </script>
{% endblock %}
