{% extends 'layout.html' %}

{% block css %}
    <style>
        .hide {
            display: none;
        }

        .shadow {
            position: fixed;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            background-color: black;
            opacity: 0.4;
            z-index: 999;
        }

        .modal-pr {
            z-index: 1000;
            position: fixed;
            left: 50%;
            top: 50%;
            height: 300px;
            width: 400px;
            background-color: white;
            margin-left: -200px;
            margin-top: -150px;
        }
    </style>

{% endblock %}

{% block content %}

    <div style="width: 90%;margin: 0 auto;">
        <h1>项目列表</h1>
        <div style="margin: 10px 0;">
            <a class="btn btn-info" onclick="showModal();">添加</a>
        </div>
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                {#            <th>序号</th>#}
                <th>ID</th>
                <th>项目名称</th>
                <th>键值</th>
                <th>发布任务</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for row in project_info %}
                <tr>
                    {#                <td>{{ forloop.counter }}</td>#}
                    <td>{{ row.pid }}</td>
                    <td>{{ row.pname }}</td>
                    <td>{{ row.kname }}</td>
                    <td><a href="{% url 'task_list' pk=row.pid %}">发布任务</a></td>
                    <td>
                        <a class="glyphicon glyphicon-pencil" onclick="modelEdit(this);">编辑</a>
                        |
                        <a class="glyphicon glyphicon-trash" onclick="removeRow(this,{{ row.pid }})">删除</a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="shadow" class="shadow hide"></div>
    <div id="modal" class="panel panel-primary modal-pr hide">
        <div class="panel-heading">添加项目</div>
        <br>
        <br>
        <form class="form-horizontal">
            <div class="form-group">
                <label for="pname" class="col-sm-2 control-label">名称</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="pname" name="pname" placeholder="项目名称">
                </div>
            </div>
            <div class="form-group">
                <label for="kname" class="col-sm-2 control-label">键值</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="kname" placeholder="键值">
                </div>
            </div>
            <p id="errormsg" style="color: red"></p>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-8">
                    <button type="submit" class="btn btn-success" value="提交" onclick="AjaxSend();">提交</button>
                    <button type="submit" class="btn btn-primary" value="取消" onclick="cancleModal();">取消</button>
                </div>
            </div>
        </form>

    </div>
    <div id="editModal" class="modal-pr hide panel panel-success">
        <div class="panel-heading">编辑项目</div>
        <br>
        <br>
        <form class="form-horizontal">
            <div class="form-group">
                <label for="editPname" class="col-sm-2 control-label">名称</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="editPname" name="pname" placeholder="项目名称">
                </div>
            </div>
            <div class="form-group">
                <label for="editKname" class="col-sm-2 control-label">键值</label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="editKname" placeholder="键值">
                </div>
            </div>
            <input id="editId" type="text" name="id" style="display: none"/>
            <p id="errormsg" style="color: red"></p>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-8">
                    <button type="submit" class="btn btn-success" value="提交" onclick="editAjaxSend();">提交</button>
                    <button type="submit" class="btn btn-primary" value="取消" onclick="cancleModal();">取消</button>
                </div>
            </div>
        </form>

    </div>
{% endblock %}
{% block js %}
    <script src="/static/js/jquery-1.12.4.js"></script>
    <script>
        function showModal() {
            document.getElementById('shadow').classList.remove('hide');
            document.getElementById('modal').classList.remove('hide');
        }

        function cancleModal() {
            document.getElementById('shadow').classList.add('hide');
            document.getElementById('modal').classList.add('hide');
            document.getElementById('editModal').classList.add('hide');
        }

        function AjaxSend() {
            $.ajax({
                url: '/rim/add_project/',
                type: 'POST',
                data: {'pname': $('#pname').val(), 'kname': $('#kname').val()},
                success: function (data) {
                    // 当服务端处理完成后，返回数据时，该函数自动调用
                    // data=服务端返回的值
                    console.log(data);
                    if (data == "ok") {
                        {#location.href = "/rim/project_list/";#}
                        location.href = "{% url 'project_list' %}";
                    } else {
                        $('#errormsg').text(data);
                    }
                }
            })
        }

        function modelEdit(ths) {
            document.getElementById('shadow').classList.remove('hide');
            document.getElementById('editModal').classList.remove('hide');
            /*
            1. 获取当前点击标签
            2. 当前标签父标签，再找其上方标签
            3. 获取当前行班级名称，赋值到编辑对话框中
             */
            var row = $(ths).parent().prevAll();
            var pname = $(row[2]).text();
            var kname = $(row[1]).text();
            $('#editPname').val(pname);
            $('#editKname').val(kname);

            var contentId = $(row[3]).text();
            $('#editId').val(contentId);
        }


        function editAjaxSend() {

            var pid = $('#editId').val();
            var pname = $('#editPname').val();
            var kname = $('#editKname').val();
            $.ajax({
                url: '/rim/edit_project/',
                type: 'POST',
                data: {'pid': pid, 'pname': pname, 'kname': kname},
                success: function (arg) {
                    // arg字符串类型
                    // JSON.parse(字符串) => 对象
                    // JSON.stringify(对象) => 字符串
                    arg = JSON.parse(arg);
                    if (arg.status) {
                        // location.href = "/classes/"
                        location.reload();
                    } else {
                        alert(arg.message);
                    }
                }
            })
        }

        function removeRow(ths, rid) {
            var result = confirm('是否确定要删除?');
            if (result) {
                $.ajax({
                    url: '/rim/project/del/' + rid + '/',
                    type: 'get',
                    dataType: "JSON",
                    success: function (res) {
                        if (res.status) {
                            $(ths).parent().parent().remove();
                        }
                    }
                });

            }
        }
    </script>
{% endblock %}
